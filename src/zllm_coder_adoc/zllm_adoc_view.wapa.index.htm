<%@page language="abap" %>                                                                                                                                                                                                                                     
<%@extension name="htmlb" prefix="htmlb" %>                                                                                                                                                                                                                    
<%                                                                                                                                                                                                                                                             
  DATA: lv_content TYPE string.                                                                                                                                                                                                                                
  DATA: lv_error TYPE string.                                                                                                                                                                                                                                  
  DATA: ls_doc TYPE zcl_llm_adoc_view=>ty_document.                                                                                                                                                                                                            
  TRY.                                                                                                                                                                                                                                                         
  ls_doc = zcl_llm_adoc_view=>get_documentation(                                                                                                                                                                                                               
  iv_obj_name = request->get_form_field( 'OBJ_NAME' )                                                                                                                                                                                                          
  iv_obj_type = request->get_form_field( 'OBJ_TYPE' ) ).                                                                                                                                                                                                       
  lv_content = ls_doc-user_content && ls_doc-sections.                                                                                                                                                                                                         
  CATCH cx_root INTO DATA(lx_error).                                                                                                                                                                                                                           
  lv_error = lx_error->get_text( ).                                                                                                                                                                                                                            
  ENDTRY.                                                                                                                                                                                                                                                      
%>                                                                                                                                                                                                                                                             
<!DOCTYPE html>                                                                                                                                                                                                                                                
<html>                                                                                                                                                                                                                                                         
<head>                                                                                                                                                                                                                                                         
  <meta charset="UTF-8">                                                                                                                                                                                                                                       
  <title>ABAP Documentation Viewer</title>                                                                                                                                                                                                                     
  <!-- Docsify CSS -->                                                                                                                                                                                                                                         
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsify/themes/vue.css">                                                                                                                                                                           
  <!-- Mermaid -->                                                                                                                                                                                                                                             
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>                                                                                                                                                                             
  <!-- Markdown -->                                                                                                                                                                                                                                            
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>                                                                                                                                                                                    
  <style>                                                                                                                                                                                                                                                      
    /* Reset Docsify's fixed positioning */                                                                                                                                                                                                                    
    body {                                                                                                                                                                                                                                                     
      position: relative !important;                                                                                                                                                                                                                           
      height: auto !important;                                                                                                                                                                                                                                 
      overflow: auto !important;                                                                                                                                                                                                                               
      font-family: Source Sans Pro,Helvetica Neue,Arial,sans-serif;                                                                                                                                                                                            
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Reset main content positioning */                                                                                                                                                                                                                       
    main {                                                                                                                                                                                                                                                     
      position: relative !important;                                                                                                                                                                                                                           
      height: auto !important;                                                                                                                                                                                                                                 
      overflow: visible !important;                                                                                                                                                                                                                            
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Documentation container */                                                                                                                                                                                                                              
    .documentation-container {                                                                                                                                                                                                                                 
      padding: 35px 40px;                                                                                                                                                                                                                                      
      max-width: 1000px;                                                                                                                                                                                                                                       
      margin: 0 auto;                                                                                                                                                                                                                                          
      min-height: 100vh;                                                                                                                                                                                                                                       
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Mermaid diagram enhancements */                                                                                                                                                                                                                         
    .mermaid {                                                                                                                                                                                                                                                 
      background: #f8f8f8;                                                                                                                                                                                                                                     
      border-radius: 4px;                                                                                                                                                                                                                                      
      padding: 20px;                                                                                                                                                                                                                                           
      margin: 1.5em 0;                                                                                                                                                                                                                                         
      text-align: center;                                                                                                                                                                                                                                      
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Override some docsify defaults */                                                                                                                                                                                                                       
    .markdown-section {                                                                                                                                                                                                                                        
      max-width: none;                                                                                                                                                                                                                                         
      padding: 0;                                                                                                                                                                                                                                              
      margin: 0;                                                                                                                                                                                                                                               
      position: relative !important;                                                                                                                                                                                                                           
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Error message styling */                                                                                                                                                                                                                                
    .error {                                                                                                                                                                                                                                                   
      background: #ffe6e6;                                                                                                                                                                                                                                     
      color: #c00;                                                                                                                                                                                                                                             
      padding: 1rem;                                                                                                                                                                                                                                           
      border-radius: 4px;                                                                                                                                                                                                                                      
      border-left: 4px solid #c00;                                                                                                                                                                                                                             
      margin: 1rem 0;                                                                                                                                                                                                                                          
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Code block enhancements */                                                                                                                                                                                                                              
    pre {                                                                                                                                                                                                                                                      
      background-color: #f8f8f8;                                                                                                                                                                                                                               
      border-radius: 4px;                                                                                                                                                                                                                                      
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    pre > code {                                                                                                                                                                                                                                               
      padding: 1.5em;                                                                                                                                                                                                                                          
      border-radius: 4px;                                                                                                                                                                                                                                      
      font-size: 0.9em;                                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Table enhancements */                                                                                                                                                                                                                                   
    .markdown-section table {                                                                                                                                                                                                                                  
      display: table;                                                                                                                                                                                                                                          
      width: 100%;                                                                                                                                                                                                                                             
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Responsive adjustments */                                                                                                                                                                                                                               
    @media screen and (max-width: 768px) {                                                                                                                                                                                                                     
      .documentation-container {                                                                                                                                                                                                                               
        padding: 20px;                                                                                                                                                                                                                                         
      }                                                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Better link colors */                                                                                                                                                                                                                                   
    a {                                                                                                                                                                                                                                                        
      color: var(--theme-color, #42b983);                                                                                                                                                                                                                      
      text-decoration: none;                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    a:hover {                                                                                                                                                                                                                                                  
      text-decoration: underline;                                                                                                                                                                                                                              
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Heading adjustments */                                                                                                                                                                                                                                  
    .markdown-section h1,                                                                                                                                                                                                                                      
    .markdown-section h2,                                                                                                                                                                                                                                      
    .markdown-section h3,                                                                                                                                                                                                                                      
    .markdown-section h4,                                                                                                                                                                                                                                      
    .markdown-section h5,                                                                                                                                                                                                                                      
    .markdown-section h6 {                                                                                                                                                                                                                                     
      color: #34495e;                                                                                                                                                                                                                                          
      font-weight: 600;                                                                                                                                                                                                                                        
      margin: 25px 0 15px;                                                                                                                                                                                                                                     
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    .markdown-section h1 {                                                                                                                                                                                                                                     
      font-size: 2rem;                                                                                                                                                                                                                                         
      margin: 0 0 1rem;                                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Blockquote styling */                                                                                                                                                                                                                                   
    blockquote {                                                                                                                                                                                                                                               
      border-left: 4px solid #42b983;                                                                                                                                                                                                                          
      color: #858585;                                                                                                                                                                                                                                          
      margin: 2em 0;                                                                                                                                                                                                                                           
      padding-left: 20px;                                                                                                                                                                                                                                      
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    /* Fix for content wrapper */                                                                                                                                                                                                                              
    #app {                                                                                                                                                                                                                                                     
      position: relative !important;                                                                                                                                                                                                                           
      height: auto !important;                                                                                                                                                                                                                                 
      overflow: visible !important;                                                                                                                                                                                                                            
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
    .content {                                                                                                                                                                                                                                                 
      position: relative !important;                                                                                                                                                                                                                           
      height: auto !important;                                                                                                                                                                                                                                 
      overflow: visible !important;                                                                                                                                                                                                                            
    }                                                                                                                                                                                                                                                          
  </style>                                                                                                                                                                                                                                                     
</head>                                                                                                                                                                                                                                                        
<body>                                                                                                                                                                                                                                                         
<htmlb:content design="CLASSIC">                                                                                                                                                                                                                               
  <%                                                                                                                                                                                                                                                           
  IF lv_error IS INITIAL.                                                                                                                                                                                                                                      
  %>                                                                                                                                                                                                                                                           
  <div class="documentation-container">                                                                                                                                                                                                                        
    <div class="markdown-section">                                                                                                                                                                                                                             
      <h1><%= ls_doc-title %></h1>                                                                                                                                                                                                                             
      <div id="content"></div>                                                                                                                                                                                                                                 
    </div>                                                                                                                                                                                                                                                     
  </div>                                                                                                                                                                                                                                                       
  <%                                                                                                                                                                                                                                                           
  ELSE.                                                                                                                                                                                                                                                        
  %>                                                                                                                                                                                                                                                           
  <div class="documentation-container">                                                                                                                                                                                                                        
    <div class="error">Error: <%= lv_error %></div>                                                                                                                                                                                                            
  </div>                                                                                                                                                                                                                                                       
  <%                                                                                                                                                                                                                                                           
  ENDIF.                                                                                                                                                                                                                                                       
  %>                                                                                                                                                                                                                                                           
<script>                                                                                                                                                                                                                                                       
    // Configure mermaid with docsify-friendly settings                                                                                                                                                                                                        
    mermaid.initialize({                                                                                                                                                                                                                                       
        startOnLoad: false,                                                                                                                                                                                                                                    
        securityLevel: 'loose',                                                                                                                                                                                                                                
        theme: 'default',                                                                                                                                                                                                                                      
        themeVariables: {                                                                                                                                                                                                                                      
            primaryColor: '#42b983',                                                                                                                                                                                                                           
            lineColor: '#42b983',                                                                                                                                                                                                                              
            textColor: '#34495e'                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
        fontFamily: 'Source Sans Pro,Helvetica Neue,Arial,sans-serif',                                                                                                                                                                                         
        flowchart: {                                                                                                                                                                                                                                           
            curve: 'basis',                                                                                                                                                                                                                                    
            padding: 15                                                                                                                                                                                                                                        
        },                                                                                                                                                                                                                                                     
        sequence: {                                                                                                                                                                                                                                            
            actorMargin: 50,                                                                                                                                                                                                                                   
            messageMargin: 40                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    const renderer = new marked.Renderer();                                                                                                                                                                                                                    
    renderer.code = function(code, language) {                                                                                                                                                                                                                 
        if (typeof code === 'object') {                                                                                                                                                                                                                        
            language = language || code.lang;                                                                                                                                                                                                                  
            code = code.text;                                                                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        if (language && language.toLowerCase() === 'mermaid') {                                                                                                                                                                                                
            return `<pre class="mermaid">${code}</pre>`;                                                                                                                                                                                                       
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        return `<pre><code class="language-${language}">${code}</code></pre>`;                                                                                                                                                                                 
    };                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    const markdown = `<%= escape( val = lv_content format = cl_abap_format=>e_xss_js  ) %>`;                                                                                                                                                                   
                                                                                                                                                                                                                                                               
    const htmlContent = marked.parse(markdown, {                                                                                                                                                                                                               
        renderer: renderer,                                                                                                                                                                                                                                    
        gfm: true,                                                                                                                                                                                                                                             
        breaks: true,                                                                                                                                                                                                                                          
        headerIds: true                                                                                                                                                                                                                                        
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    document.getElementById('content').innerHTML = htmlContent;                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
    document.addEventListener('DOMContentLoaded', function() {                                                                                                                                                                                                 
        const mermaidElements = document.querySelectorAll('.mermaid');                                                                                                                                                                                         
        if (mermaidElements.length > 0) {                                                                                                                                                                                                                      
            mermaid.init(undefined, '.mermaid');                                                                                                                                                                                                               
        }                                                                                                                                                                                                                                                      
    });                                                                                                                                                                                                                                                        
</script>                                                                                                                                                                                                                                                      
</htmlb:content>                                                                                                                                                                                                                                               
</body>                                                                                                                                                                                                                                                        
</html>                                                                                                                                                                                                                                                        